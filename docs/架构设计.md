# EPUB 翻译工具架构设计

## 1. 项目概述

EPUBot 是一个自动翻译 EPUB 电子书的工具，支持将 EPUB 文件从一种语言翻译成目标语言。该工具采用模块化设计，支持可扩展的翻译服务集成。

## 2. 系统架构

### 2.1 整体架构

```
+------------------+     +------------------+     +------------------+
|    输入EPUB      | --> |     EPUB解析器    | --> |    HTML处理器    |
+------------------+     +------------------+     +--------+---------+
                                                           |
                                                           v
+------------------+     +------------------+     +--------+---------+
|   翻译后的EPUB   | <-- |    EPUB生成器    | <-- |     翻译服务     |
+------------------+     +------------------+     +------------------+
```

### 2.2 核心组件

1. **主程序 (main.py)**
   - 命令行参数解析
   - 应用程序入口点
   - 工作流协调

2. **协调器 (Coordinator)**
   - 协调整个翻译流程
   - 管理各组件之间的交互
   - 错误处理和日志记录

3. **EPUB 处理模块**
   - `EpubParser`: 解析原始 EPUB 文件
   - `EpubBuilder`: 生成翻译后的 EPUB 文件

4. **HTML 处理模块**
   - `HTMLSplitter`: 将 HTML 内容分割成可翻译的块
   - `HTMLReplacer`: 处理 HTML 标签和占位符
   - `HTMLBuilder`: 重新构建翻译后的 HTML 内容

5. **翻译服务 (Translator)**
   - 处理与翻译 API 的交互
   - 支持异步翻译请求
   - 可扩展支持多种翻译服务

## 3. 核心工作流程

1. **输入处理**
   - 接收输入 EPUB 文件路径
   - 验证文件存在性
   - 解析命令行参数

2. **EPUB 解析**
   - 使用 `ebooklib` 解析 EPUB 文件
   - 提取元数据和内容项
   - 转换为内部表示形式

3. **内容处理**
   - 识别文档内容 (HTML/XML)
   - 分割大文件为可管理的块
   - 保留原始格式和结构

4. **翻译处理**
   - 异步发送内容到翻译服务
   - 处理翻译结果
   - 维护原始文档结构

5. **EPUB 生成**
   - 使用翻译后的内容重建 EPUB
   - 保留原始样式和资源
   - 生成目标文件

## 4. 目录结构

```
epubot/
├── __init__.py
├── config/               # 配置相关
│   ├── __init__.py
│   ├── logger.py        # 日志配置
│   └── settings.py      # 应用设置
├── schemas/             # 数据模型
│   ├── __init__.py
│   ├── chunk.py         # 文本块模型
│   └── epub.py          # EPUB 相关模型
└── services/            # 核心服务
    ├── __init__.py
    ├── coordinator.py   # 协调器
    ├── translator.py    # 翻译服务
    ├── epub/           # EPUB 处理
    │   ├── __init__.py
    │   ├── builder.py   # EPUB 生成
    │   └── parser.py    # EPUB 解析
    └── html/           # HTML 处理
        ├── __init__.py
        ├── builder.py   # HTML 构建
        ├── replacer.py  # 标签替换
        └── splitter.py  # 内容分割
```

## 5. 扩展性设计

1. **翻译服务集成**
   - 通过 `Translator` 基类定义统一接口
   - 支持轻松添加新的翻译服务

2. **配置管理**
   - 使用 `settings.py` 集中管理配置
   - 支持环境变量覆盖

3. **日志记录**
   - 结构化日志记录
   - 支持不同日志级别
   - 可配置的输出格式

## 6. 性能考虑

1. **异步处理**
   - 使用 `asyncio` 进行异步 I/O 操作
   - 并行处理多个翻译请求

2. **内存管理**
   - 流式处理大文件
   - 避免在内存中保存过多数据

3. **错误处理**
   - 健壮的错误恢复机制
   - 详细的错误日志

## 7. 后续优化方向

1. 支持更多翻译服务提供商
2. 添加进度显示
3. 支持断点续传
4. 添加更多格式支持（如 MOBI, PDF 等）